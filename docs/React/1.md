# 2:setState()
## ä¸ºä»€ä¹ˆä½¿ç”¨ setState()
ä½¿ç”¨è¿‡ React çš„ç±»ç»„ä»¶çš„æ—¶å€™ä¸€å®šé‡åˆ°è¿‡è¿™ç§æƒ…å†µ
```JS
export default class App extends Component {
  constructor(props) {
    super(props);
    this.state = {
      message: "Hello World"
    }
  }
  render() {
    return (
      <div>
        <h2>{this.state.message}</h2>
        <button onClick={e => this.changeText()}>Change</button>
      </div>
    )
  }
  changeText() {
  }
}
```
æˆ‘ä»¬é€šè¿‡ `changeText` è¿™ä¸ªå‡½æ•°æ¥æŠŠ `h2` ä¸­çš„å€¼æ”¹ç¼–æˆ 'Hello React', å¦‚æœè¿™æ ·å†™
```JS
changeText() {
  this.state.message = "Hello React";
}
```
æˆ‘ä»¬å‘ç°é¡µé¢å¹¶ä¸ä¼šå‘ç”Ÿæ”¹å˜, å­¦ä¹ è¿‡ Vue çš„ä½ è‚¯å®šä¼šäº§ç”Ÿå¾ˆå¤§çš„ç–‘æƒ‘, ä¸ºä½• React æ²¡æœ‰åƒ Vue é‚£æ ·ä¿®æ”¹å®Œæ•°æ®é¡µé¢éšä¹‹è€Œæ”¹å˜å‘¢?<br/>
::: tip
ç®€å•æ¥è¯´å°±æ˜¯ `React` å¹¶æ²¡æœ‰å®ç°ç±»ä¼¼äº `Vue2` ä¸­çš„ `Object.defineProperty` æˆ–è€… `Vue3` ä¸­çš„ `Proxy` çš„æ–¹å¼æ¥ç›‘å¬æ•°æ®çš„å˜åŒ–, ä¹Ÿå°±æ˜¯è¯´æˆ‘ä»¬ä¿®æ”¹äº† `state` ä¸­çš„æ•°æ® `React` å†…éƒ¨å¹¶ä¸çŸ¥é“æˆ‘ä»¬æ˜¯å¦ä¿®æ”¹äº†æ•°æ®, è¿›è€Œé¡µé¢ä¸ä¼šå‘ç”Ÿæ”¹å˜<br/>
:::
é‚£ä¹ˆä½ å°±é—®äº†, React æ€ä¹ˆå®ç°ä¿®æ”¹æ•°æ®è€Œéšä¹‹æ”¹å˜é¡µé¢å‘¢, ä¸‹é¢å°±å¼•å…¥äº†é‡è¦çš„ `setState()`,æˆ‘ä»¬å¯ä»¥ä¿®æ”¹ä»£ç å¦‚ä¸‹:
``` JS
changeText() {
  this.setState({
    message: "Hello React"
  })
  console.log(this.state.message); //Hello React
}
```
å¦‚æœä½ å°è¯•ä¸€ä¸‹å°±ä¼šç‚¹å‡»æŒ‰é’®å,é¡µé¢ä¹Ÿéšä¹‹å‘ç”Ÿäº†æ”¹å˜, è¿™æ—¶å€™æœ‰åŒå­¦å¥½å¥‡, ä¸ºä½•åœ¨ `setState()` ä¸­æ”¹å˜äº† setState é¡µé¢å°±ä¼šå‘ç”Ÿå“åº”å¼çš„å˜åŒ–äº†å‘¢ ç­”æ¡ˆæ˜¯:<br/> 
å½“æˆ‘ä»¬è°ƒç”¨ `setState()` æ—¶ï¼Œä¼šé‡æ–°æ‰§è¡Œ `render` å‡½æ•°ï¼Œæ ¹æ®æœ€æ–°çš„ `State` æ¥åˆ›å»º `ReactElement` å¯¹è±¡, å†æ ¹æ®æœ€æ–°çš„`ReactElement` å¯¹è±¡ï¼Œå¯¹ `DOM` è¿›è¡Œä¿®æ”¹,ä»è€Œæ¸²æŸ“å‡ºé¡µé¢ (å…³äº ReactElement å¯¹è±¡ å¯ä»¥å‚è€ƒ [1:JSXçš„æœ¬è´¨ -  ReactElement](./#ReactElement))
::: tip
`React` å®˜æ–¹æ–‡æ¡£ç»™å‡ºçš„ç®€æ´æ¦‚æ‹¬æ˜¯
`setState()` ä¼šå¯¹ä¸€ä¸ªç»„ä»¶çš„ `state` å¯¹è±¡å®‰æ’ä¸€æ¬¡æ›´æ–°ã€‚å½“ `state` æ”¹å˜äº†ï¼Œè¯¥ç»„ä»¶å°±ä¼šé‡æ–°æ¸²æŸ“ã€‚
:::

## ä¸å¯å˜å€¼(å‡½æ•°å¼ç¼–ç¨‹, çº¯å‡½æ•°)
å½“æˆ‘ä»¬æƒ³å®ç°å¦‚ä¸‹åœºæ™¯æ—¶: å®ç°å¯¹æ•°ç»„çš„åˆ—è¡¨å±•ç¤º:ä½ åº”è¯¥ä¼šè¿™æ ·å†™
``` JS
import React, { Component } from 'react';

export default class APP extends Component {
    constructor(props) {
        super(props)
        this.state = {
            list: ['ğŸapple', 'ğŸŒbanana', 'ğŸ…tomato']
        }
    }
    render() {
        return (
            <div style={{margin: '200px auto', width: '200px'}}>
                {this.state.list.map((item) => {
                    return (
                        <h1 key={item}>{item}</h1>
                    )
                })}
            </div>
        );
    }
}
```
å¦‚æœæˆ‘ä»¬æƒ³å®ç°ç‚¹å‡»æ·»åŠ æŒ‰é’®å®ç°å¯¹æ°´æœåˆ—è¡¨çš„å“åº”å¼å¢åŠ ,é‚£ä¹ˆä½ ä¼šæƒ³å¦‚ä½•å®ç°å‘¢,ä½ åº”è¯¥æƒ³åˆ°äº† `setState()`,ä½ å¯èƒ½ä¼šè¿™æ ·å®ç°:
```js
import React, { Component } from 'react';

export default class APP extends Component {
    constructor(props) {
        super(props)
        this.state = {
            list: ['ğŸapple', 'ğŸŒbanana', 'ğŸ…tomato']
        }
    }
    render() {
        return (
            <div style={{margin: '200px auto', width: '200px'}}>
                {this.state.list.map((item) => {
                    return (
                        <h1 key={item}>{item}</h1>
                    )
                })}
                <button onClick={e => {this.addPotato()}}>ï¼‹ğŸ¥”</button>
            </div>
        );
    }
    addPotato() {
        this.setState({
            list: this.state.list.push('ğŸ¥”potato')
        })
    }
}
```
ä½†é—æ†¾çš„å‘Šè¯‰ä½ è¿™æ ·å¹¶ä¸èƒ½å®ç°å¯¹æ•°ç»„ä¸­æ•°æ®çš„å¢åŠ , ç‚¹å‡»æŒ‰é’®åæ§åˆ¶å°ä¼šæŠ¥è¿™æ ·ä¸€æ®µé”™è¯¯
::: danger
TypeError: this.state.list.map is not a function
:::
å› ä¸º `this.state.list.push('ğŸ¥”potato')` çš„è¿”å›å€¼æ˜¯æ”¹å˜åæ•°ç»„çš„é•¿åº¦, æ‰€ä»¥`list.map is not a function`,é‚£ä¹ˆæˆ‘ä»¬å¯ä»¥ä¿®æ”¹ä¸ºå¦‚ä¸‹ä»£ç 
```js
    addPotato() {
        this.setState({
            list: this.state.list.concat('ğŸ¥”potato')
        })
    }
```
è¿™æ ·å®ç°ç‚¹å‡»åå°±ä¼šå‘ç°å¯ä»¥å¯¹åˆ—è¡¨è¿›è¡Œå¢åŠ äº†, å¦‚ä¸‹å›¾:<br/>
![xxx](../images/React/1/0.gif)
è¿™ç§å¯¹æ•°æ®ä¿®æ”¹çš„æ–¹æ³•ä¹Ÿæ˜¯ React å®˜æ–¹æ–‡æ¡£æ‰€æåˆ°çš„ **ä¸å¯å˜æ•°æ®çš„åŠ›é‡**,ä¹Ÿå°±æ˜¯è¯´ä¸èƒ½å¯¹ this.state.list è¿›è¡Œ push pop splice ç­‰æ“ä½œ, å…³äº **ä¸å¯å˜æ•°æ®çš„åŠ›é‡** å¯ä»¥å‚è€ƒ [X:React æ€§èƒ½ä¼˜åŒ– -  SCUä¼˜åŒ–](./#ReactElement)</br>
æ‰€ä»¥å¯¹ Array çš„æ“ä½œå»ºè®®ä½¿ç”¨ä»¥ä¸‹æ–¹æ³•:
::: tip
```js
this.state.list1.concat(100), // è¿½åŠ 
[...this.state.list2, 100], // è¿½åŠ 
this.state.list3.slice(0, 3), // æˆªå–
this.state.list4.filter(item => item > 100), // ç­›é€‰
```
:::
å¯¹ Object æ‰€å»ºè®®çš„æ–¹æ³•:
::: tip
``` js
Object.assign({}, this.state.obj1, {a: 100}) //è¿½åŠ 
{...this.state.obj2, a: 100}  //è¿½åŠ 
```
:::

## åŒæ­¥è¿˜æ˜¯å¼‚æ­¥?
æ ¹æ®ä¸Šé¢çš„ä»£ç ç›¸ä¿¡ä½ å·²ç»äº†è§£äº† `setState()` çš„åŸºæœ¬ä½¿ç”¨,ç°åœ¨é—®ä½ ä¸€ä¸ªé—®é¢˜, `setState()` æ˜¯åŒæ­¥æ›´æ–°çš„è¿˜æ˜¯å¼‚æ­¥æ›´æ–°çš„,ä¹Ÿå°±æ˜¯è¯´ç‚¹å‡» Hello React ä¸‹é¢çš„ `console.log(this.state.message);`ä¼šæ‰“å°å‡ºä»€ä¹ˆ?
### æµ‹è¯•ä¸€:
```js {21}
import React, { Component } from 'react';

export default class APP extends Component {
    constructor(props) {
        super(props)
        this.state = {
            message: 'Hello React'
        }
    }
    render() {
        return (
            <div>
                <h2 onClick={e => {this.changeMessage()}}>{this.state.message}</h2>
            </div>
        );
    }
    changeMessage() {
        this.setState({
            message : 'ä½ å¥½,React'
        })
        console.log(this.state.message);
    }
}
```
æˆ‘ä»¬æ‰§è¡Œä»£ç å‘ç°æ§åˆ¶å°æ‰“å°å‡º `Hello React`, é‚£æˆ‘ä»¬å¯ä¸å¯ä»¥å¾—å‡º `setState()` æ˜¯å¼‚æ­¥çš„è¿™ä¸ªç»“è®ºäº†å‘¢,æˆ‘ä»¬å…ˆä¸ç€æ€¥ä¸‹ç»“è®º,å†çœ‹ä¸€ä¸‹ä¸‹é¢çš„ä¸€ç§æƒ…å†µ,ä»£ç å¦‚ä¸‹:
### æµ‹è¯•äºŒ:
```js {23,31}
import React, { Component } from 'react';

export default class APP extends Component {
    constructor(props) {
        super(props)
        this.state = {
            message: 'Hello React'
        }
    }
    render() {
        return (
            <div>
                <h2 onClick={e => {this.changeMessage()}}>{this.state.message}</h2>
                <button id="btn">changeMessage</button>
            </div>
        );
    }
    componentDidMount() {
        document.getElementById('btn').addEventListener('click', () => {
            this.setState({
                message: 'ä½ å¥½, React'
            })
            console.log(this.state.message);
        })
    }    
    changeMessage() {
        setTimeout(() => {
            this.setState({
                message: 'ä½ å¥½, React'
            })
            console.log(this.state.message);
        }, 0);
    }
}
```
ä¸Šé¢ä»£ç ä¸­æˆ‘ä»¬æŠŠ setStateä¸€ä¸ªå†™åœ¨äº† è‡ªå®šä¹‰äº‹ä»¶ä¸­, å¦ä¸€ä¸ªå†™åœ¨äº† setTimeoutä¸­,æ¥ä¸‹æ¥æˆ‘ä»¬ç‚¹å‡»æŒ‰é’®æ§åˆ¶å°ä¸­è¾“å‡º `ä½ å¥½, React` åˆ·æ–°é¡µé¢ç‚¹å‡» `<h2>Hello React</h2>`æ§åˆ¶å°è¾“å‡ºä¹Ÿæ˜¯ `ä½ å¥½,React`
### ç»“è®º
é€šè¿‡ä¸Šé¢çš„æµ‹è¯•ç»“æœæˆ‘ä»¬å¯ä»¥å¾—å‡º `setState()` åœ¨æ­£å¸¸æƒ…å†µä¸‹æ˜¯å¼‚æ­¥çš„, åœ¨ **setTimeout** ä¸­å’Œ **è‡ªå®šä¹‰äº‹ä»¶ä¸­**æ˜¯åŒæ­¥çš„
### æ€è€ƒä¸€
åœ¨æ­£å¸¸æƒ…å†µä¸‹æˆ‘ä»¬æ˜¯å¦å¯ä»¥æ‹¿åˆ° setState() æ›´æ–°ä¹‹åçš„å€¼å‘¢,æˆ‘ä»¬å» React æºç ä¸­ç§ä¸€ç§ä¼šå‘ç° setState() æºç æ˜¯è¿™æ ·çš„
```js
Component.prototype.setState = function(partialState, callback) {
  invariant(
    typeof partialState === 'object' ||
      typeof partialState === 'function' ||
      partialState == null,
    'setState(...): takes an object of state variables to update or a ' +
      'function which returns an object of state variables.',
  );
  this.updater.enqueueSetState(this, partialState, callback, 'setState');
};
```
æˆ‘ä»¬å‘ç° setState() ä¸­æ¥æ”¶äº†ä¸¤ä¸ªå‚æ•°,æˆ‘ä»¬æ”¹å†™ **æµ‹è¯•ä¸€** ä¸­çš„ `changeMessage` ä»£ç å¦‚ä¸‹:
```js
changeMessage() {
    this.setState({
        message : 'ä½ å¥½,React'
    }, () => {
        console.log(this.state.message); //ä½ å¥½,React
    })
}
```
åœ¨æ§åˆ¶å°ä¸­ä¼šæ‰“å°å‡º `ä½ å¥½,React`,ä¹Ÿå°±æ˜¯è¯´æˆ‘ä»¬å¯ä»¥åœ¨ `setState()` çš„ç¬¬äºŒä¸ªå‚æ•°çš„çš„å›è°ƒå‡½æ•°ä¸­æ‹¿åˆ° `setState()` æ›´æ–°ä¹‹åçš„å€¼
### æ€è€ƒäºŒ
ä½¿ç”¨ `setState()` åä½ ä¼šä¸ä¼šäº§ç”Ÿè¿™æ ·çš„ç–‘é—®,æ—¢ç„¶æ‹¿åˆ° `setState()` å¼‚æ­¥æ›´æ–°åçš„å€¼è¿™ä¹ˆéº»çƒ¦? ç›´æ¥æŠŠä»–è®¾è®¡æˆåŒæ­¥æ›´æ–°çš„ä»–ä¸é¦™å—? æ²¡é”™,ä¸å…‰ä½ ä¸€ä¸ªäººæœ‰è¿™ç§æƒ³æ³•,è®¸å¤šäººåœ¨ React çš„ Github ä¸Šé¢éƒ½æå‡ºäº†è¿™ä¸ª Issues, Reactæ ¸å¿ƒæˆå‘˜ç»™å‡ºäº†ç›¸åº”çš„è§£é‡Š
::: tip
ä¸ªäººæ€»ç»“å¦‚ä¸‹:<br/>
1.setStateè®¾è®¡æˆå¼‚æ­¥,å¯ä»¥æ˜¾è‘—çš„æå‡æ€§èƒ½(å¦‚æœæ‰§è¡Œå¤šä¸ªsetState,æ¯ä¸ªsetStateéƒ½è¿›è¡Œä¸€æ¬¡æ›´æ–°,é‚£ä¹ˆæ„å‘³ç€rendeé¢‘ç¹çš„è°ƒç”¨,ç•Œé¢é‡æ–°æ¸²æŸ“,è¿™æ ·æ€§èƒ½å¾ˆä½,Reactçš„åšæ³•æ˜¯è·å–åˆ°å¤šä¸ªæ›´æ–°çš„æ•°æ®,ç„¶åè¿›è¡Œæ‰¹é‡æ›´æ–°)
2.å¦‚æœåŒæ­¥æ›´æ–°äº†state,ä½†è¿˜æ²¡æœ‰æ‰§è¡Œrenderå‡½æ•°,é‚£ä¹ˆstateå’Œpropså°±ä¸èƒ½ä¿æŒåŒæ­¥
:::
## setState()åˆå¹¶
ä¸Šé¢çš„ä»£ç æˆ‘ä»¬éƒ½åªæ‰§è¡Œäº†ä¸€æ¬¡ setState() ,å¦‚æœæˆ‘ä»¬å†™å¤šä¸ª setStateä¼šæ€æ ·?å¦‚ä¸‹ä»£ç 
```js
import React, { Component } from 'react';

export default class App extends Component {
    constructor(props) {
        super(props)
        this.state = {
            counter: 0
        }
    }
    render() {
        return (
            <div>
                <h2>{this.state.counter}</h2>
                <button onClick={e => {
                    this.handleAdd()
                }}>+</button>
            </div>
        );
    }
    handleAdd() {
        this.setState({
            counter: this.state.counter + 1
        })
        this.setState({
            counter: this.state.counter + 2
        })
        this.setState({
            counter: this.state.counter + 3
        })
    }
}
```
ç‚¹å‡»æŒ‰é’® `<h2></h2>` ä¸­çš„æ•°å­—åªæ˜¯å˜åˆ°äº† `3` ä¹Ÿå°±æ˜¯è¯´è¿™ä¸‰ä¸ª setState()æœ€ç»ˆåˆå¹¶æˆäº†æœ€åä¸€ä¸ª setState() é€šè¿‡æºç ä¸­å‘ç°è¿™ä¸ªåˆå¹¶çš„æ–¹æ³•æ˜¯ `Object.assign()` æ–¹æ³•,å…·ä½“åˆ°è¿™ä¸ªä¾‹å­å°±æ˜¯:<br/> 
```js
Object.assign({}, state, {counter: this.state.counter + 1}, {counter: this.state.counter + 2}, {counter: this.state.counter + 3})
```
æ‰€ä»¥æœ€ç»ˆ `<h2></h2>` ä¸­çš„æ•°å­—å°±ä¸º `3`<br/>
**å¦‚æœæˆ‘ä»¬ä¸æƒ³è®© setStateè¿›è¡Œåˆå¹¶**å¯ä»¥æ”¹å†™ `handleAdd()` ä»£ç å¦‚ä¸‹:
```js
handleAdd() {
    this.setState((prevState) => {
        return {
            counter: prevState.counter + 1
        }
    })
    this.setState((prevState) => {
        return {
            counter: prevState.counter + 2
        }
    })
    this.setState((prevState) => {
        return {
            counter: prevState.counter + 3
        }
    })
}
```
åœ¨ `setState()` çš„å‡½æ•°ä¸­è¿”å› å¯¹è±¡è¿™æ ·å°±ä¸ä¼šè¿›è¡Œåˆå¹¶äº†

